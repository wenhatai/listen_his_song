<?php
/*
Uploadify
Copyright (c) 2012 Reactive Apps, Ronnie Garcia
Released under the MIT License <http://www.opensource.org/licenses/mit-license.php> 
*/
require_once("../modules/class.song.php");
require_once("../modules/class.user.php");

$ret = array();
/*
if(!isset($_POST['name']) || !isset($_POST['singer'])){
	echo "Need 2 params!".$_POST['name'];
	exit();
}
*/
if (!empty($_FILES)) {
	$tempFile = $_FILES['Filedata']['tmp_name'];
	$targetFolder = '/listen-his-songs/music'; // Relative to the root
	$targetPath = $_SERVER['DOCUMENT_ROOT'] . $targetFolder;
	$targetFile = rtrim($targetPath,'/') . '/';//$_FILES['Filedata']['name'];
	
	// Validate the file type
	$fileTypes = array('mp3'); // File extensions
	$fileParts = pathinfo($_FILES['Filedata']['name']);
	if (in_array($fileParts['extension'],$fileTypes)) {
		$song = new Song();
		$song->songName = $_REQUEST['name'];
		$song->singerName = $_REQUEST['singer'];
		if($song->isExist()){
			// 如果文件已经存在，就返回错误码1
			$ret['ret'] = 1;
			$ret['msg'] = "MP3 file had been uploaded by some other body!";
			exit();
		}
		$sid = $song->insert();
		move_uploaded_file($tempFile,$targetFile.$sid."song.mp3");
		
		$user = new User();
		$user->upload_song($_REQUEST['openid'], $sid);
		// 正常的返回码为0
		$ret['ret'] = '0';
		$ret['src'] = "music/".$sid."song.mp3";
		$ret['msg'] = "No error!";
		$ret['sname'] = $_REQUEST['name'];
	} else {
		// 文件类型不对，返回错误码2
		$ret['ret'] = 2;
		$ret['msg'] = 'Invalid file type.';
	}
}

echo json_encode($ret);
?>