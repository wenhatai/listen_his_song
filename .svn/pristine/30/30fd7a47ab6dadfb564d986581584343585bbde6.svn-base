<?PHP
require_once("class.base.php");

class Genre extends Conn{
	private $sid = 0;
	private $name;
	private $src;
	private $genre_name;
	private $times;
	private $song=array();
	private $songlist=array();
	
	//获取歌曲列表
	function songlist($uid){
		$n=0;
		$sql1="SELECT sid FROM user_song WHERE uid=?";
		$stmt1= $this->mysqli->prepare($sql1);
		$stmt1->bind_param("i",$uid);
		$stmt1->execute();
		$stmt1->bind_result($col1);
		while($stmt1->fetch()){
			$this->song[$n]=$col1;
			$n++;
		}
		$stmt1->close();
		$sql2="SELECT name,genre_name FROM song WHERE sid=?";
		$stmt2= $this->mysqli->prepare($sql2);
		for($i=0;$i<$n;$i++){
			$stmt2->bind_param("i",$this->song[$i]);
			$stmt2->execute();
			$stmt2->bind_result($col2,$col3);
			while($stmt2->fetch()){
				$this->songlist[$i][0]=$col2;
				$this->songlist[$i][1]=$col3;
			}
		}
		$stmt2->close();
		for($i=0;$i<$n;$i++){
			echo $this->song[$i]."|".$this->songlist[$i][0]."|".$this->songlist[$i][1];
			if($i<$n-1)
				echo "!";
		}
	}
	
	
	//返回每个已经添加用户的流派
	function usergenre($uid){
		$name=array();
		$i=0;
		$sql = "SELECT name FROM users_genre WHERE user_id=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i", $uid);
		$stmt->execute();
		$stmt->bind_result($col1);
		while($stmt->fetch()){
			$name[$i]= $col1;
			$i++;
		}
		$stmt->close(); 
		return $name;
	}
	
	//增加流派
	function addgenre($uid,$add){
		$i=0;
		$sql = "INSERT INTO users_genre (name,num,user_id) VALUES (?, ?, ?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("sii",$add, $i, $uid);
		$stmt->execute();
		$stmt->close();
		return true;
	}

	
	//修改流派
	function modgenre($uid,$old,$new){
		$sql = "UPDATE users_genre SET name=? WHERE user_id=? AND name=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("sis",$new, $uid,$old);
		$stmt->execute();
		$stmt->close();
		return true;
	}
	
	//删除流派
	function delgenre($uid,$del){
		$sql = "DELETE FROM users_genre WHERE user_id=? AND name=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("is",$uid,$del);
		$stmt->execute();
		$stmt->close();
		return true;
	}
	
	
	function __get($property){
		if(isset($this->$property)){
			return $this->$property;
		} else {
			return NULL;
		}
	}
		
	function __set($property, $value){
		$this->$property = $value;
	}
}
?>