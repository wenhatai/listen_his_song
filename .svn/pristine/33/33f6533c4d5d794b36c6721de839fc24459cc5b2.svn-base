/*
 * 封装openapi的所有ajax初始化请求。
 *
 * Url类，封装了对url的解读，能从当前url里面获取
 * openid、openkey、pf等参数
 *
 * @函数 getAppFriends:ajax请求获取使用此应用的好
 * 友，在ajax获取个人信息后立即调用。
 *
 * @函数 findGroups:ajax请求获取用户的所有分组，在
 * getAppFriends调用成功后立即调用。
 *
 * @函数 findFriendByFid:根据fopenid获取好友的信息
 * 说明一点，在getAppFriends调用后，所有的好友信息
 * 的json对象都保存在全局变量friends里面。
 *
 */
function Url(){
	url = location.href;
	this.getHttpParams = function(name)
	{
        var r = new RegExp("(\\?|#|&)"+name+"=([^&#]*)(&|#|$)");
        var m = url.match(r);
        return decodeURIComponent(!m?"":m[2]);
	}
}
urlObj = new Url();
openid = urlObj.getHttpParams("openid");
openkey = urlObj.getHttpParams("openkey");
pf = urlObj.getHttpParams("pf");
if(pf == ""){
	pf = "qzone";
}
var friends;

function appendFriend(id, friend){
	$("#" + id).append("<li id='"+friend.openid+
		"' class='ui-widget-content ui-corner-tr ui-draggable'><img src='"
		+friend.figureurl+"'/><span>"+friend.nickname+
		"</span></li>");
}
	
function createGroup(groupname){
	$.ajax({
		url:"p/addgroup.php",
		method:"POST",
		data:{'openid':openid, 'groupname':groupname},
		success:function(data){
			alert(data);
		}
	});
}

function findGroups(){
	$.ajax({
		url:"p/findGroups.php",
		method:"POST",
		data:{"myopenid":openid},
		success:function(data){
			var groups = eval('(' + data + ')');
			var i, j;
			for(i = 0; i < groups.length; i++){
				$("#friendlist ul:first").append("<li class='grouping'><span class='friendtitle'>"+
					groups[i].name+"</span><ul class='list' id='group_"+groups[i].id+"'></ul></li>");
				for(j = 0; j < groups[i].friends.length; j++){
					var friend = findFriendByFid(groups[i].friends[j].openid);
					appendFriend("group_"+groups[i].id, friend);
				}
			}
		}
	});
}
function getAppFriends(){
	$.ajaxSetup({
		async: false
	});
	$.ajax({
		url:"openapi-3.0.2/get_app_friends.php",
		method:"GET",
		data:{
			"openid":openid, 
			"openkey":openkey, 
			"pf":pf
		},
		success:function(data){
			friends = eval('(' + data + ')');
			if(friends.ret != 0){
				getAppFriends();
				return;
			}
			var i;
			for(i=0; i< friends.items.length; i++){
				appendFriend("allfriends", friends.items[i]);
			}
			findGroups();
		}
	});
}

function findFriendByFid(fid){
	var i;
	for(i = 0; i < friends.items.length; i++){
		if(friends.items[i].openid == fid){
			return friends.items[i];
		}
	}
}

function getMyInfo(){
	$.ajax({
		url:"openapi-3.0.2/get_user_info.php",
		method:"GET",
		data:{
			"openid":openid, 
			"openkey":openkey, 
			"pf":pf
		},
		success:function(data){
			var myinfo = eval('(' + data + ')');
			if(myinfo.ret != 0){
				getMyInfo();
				return;
			}
			$("#allfriends").append("<li id='"+openid+"' class='ui-widget-content ui-corner-tr'><img src='"+
				myinfo.figureurl+"'/><span>"+myinfo.nickname+"</span></li>");
			getAppFriends();
		}
	});
}

getMyInfo();

$(document).ready(function(){
	$("#invite").click(function(){
		fusion2.dialog.invite({
			msg:"邀请你来玩~",
			context:"invite",
			onSuccess:function(opt){
				alert("邀请成功"+opt.context);
			}
		});
	});
});