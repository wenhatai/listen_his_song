<?php
require_once("../../modules/class.song.php");
require_once("../../modules/class.user.php");
require_once("../../modules/class.listenedSong.php");

$uid = $_REQUEST['openid'];
$newSong = array();
$newSong['name'] = $_REQUEST['sname'];
$newSong['singer'] = $_REQUEST['singer'];
if($_REQUEST['album'] != "none"){
	$newSong['album'] = $_REQUEST['album'];
}
$newSong['src'] = $_REQUEST['src'];

$song = new Song();
$sid = $song->isExist($newSong);
$usid = null;

if(!$sid){
	$sid = $song->insert($newSong);
	$user = new User($uid);
	$usid = $user->listenANewSong($sid);
} else {
	$ret = $song->is_myplaylist($sid, $uid);
	if(!$ret){
		$user = new User($uid);
		$usid = $user->listenANewSong($sid);
	} else {
		$usid = $ret['usid'];
		if($ret['flag'] == 0){
			$user = new User($uid);
			$user->findSongBack($ret['usid']);
		}
	}
}

$listenedSong = new ListenedSong();
$listenedSong->insert($usid);

echo $usid;
?>