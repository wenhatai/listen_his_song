<?php
include("config.php");
require_once("class.friend.php");

class Group{
	private $mysqli;
	//private $id;
	//private $creatorOpenid;
	//private $name;

	// 构造函数
	function __construct(){
		$this->mysqli = new mysqli($GLOBALS['address'], $GLOBALS['username'], $GLOBALS['password'], $GLOBALS['schema']);
		if($this->mysqli->connect_errno){
			echo "Connect failed:%s\n".$this->mysqli->connect_error();
			exit();
		}
		$this->mysqli->query("set names utf8");
		//$this->mysqli->query("set character_set_results=GBK");
	}
	
	// 析构函数
	function __destruct(){
		if($this->mysqli){
			$this->mysqli->close();
		}
	}
	
	function insert($openid, $groupName){
	    $sql = "INSERT INTO fgroup (openid,name) VALUES (?, ?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $openid, $groupName);
		$stmt->execute();
		$stmt->close();
		$this->uid = $this->mysqli->insert_id;
		return $this->uid;
	}
	
	function getMyGroups($myopenid){
		$result = array();
		$friend = new Friend();
		$sql = "SELECT id,name FROM fgroup WHERE openid = ?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("s", $myopenid);
		$stmt->execute();
		$stmt->bind_result($gid, $gname);
		$i = 0;
		while($stmt->fetch()){
			$result[$i] = array();
			$result[$i]['id'] = $gid;
			$result[$i]['name'] = $gname;
			$result[$i]['friends'] = $friend->findFriendsInGroup($gid);
			$i++;
		}
		$stmt->close();
		return $result;
	}
}
?>