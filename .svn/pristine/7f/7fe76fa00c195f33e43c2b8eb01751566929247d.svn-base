<?PHP
require_once("class.base.php");
require_once("class.song.php");
class Songrate{
    public $five_days_rate;
	public $ten_days_rate;
	public $fifteen_days_rate;
	public $one_month_rate;
	public $sid;
	}
class Search extends Conn{
	private $uid;
	private $userfri=array();
	private $friname=array();
	private $rate=array();
	private $users = array();
	private $songs = array();
	private $order_five_days = array();
	private $order_ten_days=array();
	private $order_fifteen_days=array();
	private $order_month=array();
	private $songname=array();
	private $songsid=array();
	private $songgenre=array();
	private $songtimes=array();
	private $songsinger=array();
	
	//通过用户id获取用户好友，返回好友数组
	function friends($uid){
		$sql = "SELECT fid,nickname FROM friend WHERE uid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i",$uid);
		$stmt->execute();
		$stmt->bind_result($col1,$col2);
		$i = 0;
		while($stmt->fetch()){
			$this->userfri[$i]=$col1;
			$this->friname[$i]=$col2;
			$i++;
		}
		$stmt->close();
		return $i;
	}
	
	// 模糊查询歌曲
	function songsByName($name){
	    		
		$sql = "SELECT sid,name,genre_name,singer FROM song WHERE song.name LIKE ?";
		$stmt = $this->mysqli->prepare($sql);
		$prepare='%'.$name.'%';
		$stmt->bind_param("s", $prepare);
		$stmt->execute();
		$stmt->bind_result($col1, $col2, $col3,$col4);
		$i = 0;
		while($stmt->fetch()){
			$this->songs[$i] = new Song();
			$this->songs[$i]->sid = $col1;
			$this->songs[$i]->name = $col2;
			$this->songs[$i]->genre_name = $col3;
			$this->songs[$i]->singer = $col4;
			$i++;
		}
		$stmt->close();
		return $i;
	}
	
	//根据歌曲名精确查询歌曲sid
	function getsongsidBysongname($songname)
	{
	   $sql = "SELECT sid FROM song WHERE name = ?";
	   $stmt = $this->mysqli->prepare($sql);
	   $stmt->bind_param("s",$songname);
	   $stmt->execute();
	   $stmt->bind_result($col1);
		$i = 0;
		while($stmt->fetch()){
			$this->songname[$i]= $col1;
			$i++;
		}
        $stmt->close();	
        return $i;		
	}
	// 获取某用户最近听的最多的歌曲
	function songListOfUser($openid){
		$ret = array();
		$sql1 = "SELECT song.sid, song.name, song.singer, song.genre_name FROM song, user_song WHERE song.sid = user_song.sid AND user_song.openid=? ORDER BY times_5d DESC";
		$stmt = $this->mysqli->prepare($sql1);
		$stmt->bind_param("s", $openid);
		$stmt->execute();
		$stmt->bind_result($sid, $sname, $singer, $genre);
		$i = 0;
		$ret['songs'] = array();
		while($stmt->fetch()){
			$ret['songs'][$i] = array();
			$ret['songs'][$i]['sid'] = $sid;
			$ret['songs'][$i]['name'] = $sname;
			$ret['songs'][$i]['singer'] = $singer;
			$ret['songs'][$i]['genre'] = $genre;
			$i++;
		}
		$ret['num'] = $i;
		$stmt->close();
		return $ret;
	}
	
	//根据天数显示用户或其好友的歌曲频率排名
	function songlistorderbydays($id,$days){
		if($days==1)
			$sql1 = "SELECT sid,times_5d FROM user_song WHERE uid=? order by times_5d desc";
		if($days==2)
			$sql1 = "SELECT sid,times_10d FROM user_song WHERE uid=? order by times_10d desc";
		if($days==3)
			$sql1 = "SELECT sid,times_15d FROM user_song WHERE uid=? order by times_15d desc";
		if($days==4)
			$sql1 = "SELECT sid,times_30d FROM user_song WHERE uid=? order by times_30d desc";
		$stmt = $this->mysqli->prepare($sql1);
		$stmt->bind_param("i", $id);
		$stmt->execute();
		$stmt->bind_result($col1,$col2);
		$n = 0;
		while($stmt->fetch()){
			$days_rate[$n] = $col1;
			$days_hot [$n] = round($col2,3)*100;
			$n++;
		}
		for($i=0;$i<$n;$i++){
			$sql2 = "SELECT name,genre_name FROM song WHERE sid=?";
			$stmt = $this->mysqli->prepare($sql2);
			$stmt->bind_param("i",$days_rate[$i]);
			$stmt->execute();
			$stmt->bind_result($col3,$col4);
			if($stmt->fetch()){
				$days_info[$i][0]=$col3;
				$days_info[$i][1]=$col4;
			}
			$stmt->close();
		}
		for($i=0;$i<$n;$i++){
			echo $days_rate[$i]."|".$days_info[$i][0]."|".$days_info[$i][1]."|".$days_hot[$i]."%";
			if($i<$n-1)
				echo "!";
		}
	}
	
	
	//通过sid获取song表中的曲目,歌手,流派
	function getsongnameBysid($sid)
	{
	    $sql = "SELECT name,genre_name,singer FROM song WHERE sid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i", $sid);
		$stmt->execute();
		$stmt->bind_result($col1,$col2,$col3);
		$i = 0;
		while($stmt->fetch()){
			$this->songname[$i] = $col1;
			$this->songgenre[$i] = $col2;
			$this->songsinger[$i] = $col3;
			
			++$i;
		}
		$stmt->close();
	}
	//获取用户最近五天，十天，十五天，一个月听的歌
	function getsongs_bydays($uid,$days)
	{
		$ret = array();
		$sql="SELECT song.sid, song.name, song.genre_name, song.singer".
			" FROM song,user_song WHERE song.sid = user_song.sid AND ".
			"user_song.openid=? AND user_song.$days !=0 AND five_days_key".
			" = 1 order by $days desc";
		$stmt=$this->mysqli->prepare($sql);
		$stmt->bind_param("s",$uid);
		$stmt->execute();
		$stmt->bind_result($sid, $sname, $genre, $singer);
		$i=0;
		$ret['songs'] = array();
		while($stmt->fetch()){
			$ret['songs'][$i] = array();
			$ret['songs'][$i]['sid'] = $sid;
			$ret['songs'][$i]['name'] = $sname;
			$ret['songs'][$i]['genre'] = $genre;
			$ret['songs'][$i]['singer'] = $singer;
			++$i;
		}
		$ret['num'] = $i;
		$stmt->close();
		return $ret;
	}
	
	
	// 获取流派里面所有歌曲排名
	function songListInGenre($genre_name){
	    $sql = "SELECT name FROM song WHERE genre_name=? order by times desc";
		$stmt=$this->mysqli->prepare($sql);
		$stmt->bind_param("s",$genre_name);
		$stmt->execute();
		$stmt->bind_result($col1);
		$i = 0;
		while($stmt->fetch()){
		   $this->songname[$i] = $col1;
		   ++$i;
		}
		$stmt->close();
		return $i;
	}
	
	//获取某好友某首歌的频率
	function songfriendrate($id,$song){
		$ret = false;
		$sql1="SELECT sid FROM song WHERE name=?";
		$stmt1 = $this->mysqli->prepare($sql1);
		$stmt1->bind_param("s", $song);
		$stmt1->execute();
		$stmt1->bind_result($col1);
		if($stmt1->fetch()){
			$song_id=$col1;
		}
		else{
			return $ret;
		}
		$stmt1->close();
		$sql2 = "SELECT five_days_rate,ten_days_rate,fifteen_days_rate,one_month_rate 
		FROM user_song WHERE uid=? AND sid=?";
		$stmt2 = $this->mysqli->prepare($sql2);
		$stmt2->bind_param("ii",$id,$song_id);
		$stmt2->execute();
		$stmt2->bind_result($col1, $col2, $col3,$col4);
		if($stmt2->fetch()){
			$this->rate[0] = $col1;
			$this->rate[1] = $col2;
			$this->rate[2] = $col3;
			$this->rate[3] = $col4;
			$ret = true;
		}
		$stmt2->close();
		return $ret;
	}
	
	function songsQuery($input){
		$ret = array();
		$params = split('\s', $input);
		$sql = "SELECT sid,name,singer,genre_name,src FROM song WHERE name LIKE ? OR singer LIKE ? OR genre_name LIKE ? LIMIT 30";
		foreach ($params as $param){
			$param = '%'.$param.'%';
			$stmt = $this->mysqli->prepare($sql);
			$stmt->bind_param("sss", $param, $param, $param);
			$stmt->execute();
			$stmt->bind_result($sid, $name, $singer, $album, $src);
			while($stmt->fetch()){
				if(!isset($ret[$sid])){
					$ret[$sid] = array();
					$ret[$sid]['sid'] = $sid;
					$ret[$sid]['name'] = $name;
					$ret[$sid]['singer'] = $singer;
					$ret[$sid]['album'] = $album;
					$ret[$sid]['src'] = $src;
				}
			}
			$stmt->close();	
		}
		return $ret;
	}
	
	function __get($property){
		if(isset($this->$property)){
			return $this->$property;
		} else {
			return NULL;
		}
	}
		
	function __set($property, $value){
		$this->$property = $value;
	}
}
?>