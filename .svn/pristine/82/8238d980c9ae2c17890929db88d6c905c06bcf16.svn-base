<?php
require_once("config.php");

class Song{
	private $songName;
	private $singerName;
	private $mysqli;
	
	// 构造函数
	function __construct($name=NULL, $singer=NULL){
		$this->songName = $name;
		$this->singerName = $singer;
		$this->mysqli = new mysqli($GLOBALS['address'], $GLOBALS['username'], $GLOBALS['password'], $GLOBALS['schema']);
		if($this->mysqli->connect_errno){
			echo "Connect failed:%s\n".mysqli_connect_error();
			exit();
		}
		$this->mysqli->query("set names utf8");
	}
	
	// 析构函数
	function __destruct(){
		if($this->mysqli){
			$this->mysqli->close();
		}
	}
	
	function insert(){
		$sql = "INSERT INTO song (name, singer) VALUES (?, ?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $this->songName, $this->singerName);
		$stmt->execute();
		$stmt->close(); 
		$this->uid = $this->mysqli->insert_id;
		return $this->uid;
	}
	
	function isExist(){
		$ret = true;
		$sql = "SELECT * FROM song WHERE name = ? AND singer = ?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $this->songName, $this->singerName);
		$stmt->execute();
		$stmt->store_result();
		if($stmt->num_rows != 1){
			$ret = false;
		}
		$stmt->close(); 
		return $ret;
	}
	
	//通过点击好友id获取好友的歌
	function friendsongs($id){
		$result=false;
		$song=new Song;
		$i=0;
		$sql="SELECT sid,time_5d,time_10d,time_15d,time_30d FROM users_songs WHERE openid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("s",$id);
		$stmt->execute();
		$stmt->bind_result($col1,$col2,$col3,$col4,$col5);
		while($stmt->fetch()){
			$result[$i]['sid']=$col1;
			$result[$i]['5d']=$col2;
			$result[$i]['10d']=$col3;
			$result[$i]['15d']=$col4;
			$result[$i]['30d']=$col5;
			$result[$i]['song']=$song->song_info($col1);
			$i++;
		}
		$stmt->close();
		return $result;
	}
	
	
	
	//得到歌曲信息
	function song_info($sid){
		$result=false;
		$sql="SELECT name,src,genre_name FROM song WHERE sid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i",$sid);
		$stmt->execute();
		$stmt->bind_result($col1,$col2,$col3);
		if($stmt->fetch()){
			$result['name']=$col1;
			$result['src']=$col2;
			$result['genre_name']=$col3;
		}
		$stmt->close();
		return $result;
	}
	
	function __get($property){
		if(isset($this->$property)){
			return $this->$property;
		} else {
			return NULL;
		}
	}
		
	function __set($property, $value){
		$this->$property = $value;
	}
}
?>