<?php
$sname = $_REQUEST['sname'];
$url='http://cgi.music.soso.com/fcgi-bin/m.q?w='.urlencode(mb_convert_encoding($sname, 'gb2312', 'utf-8')).'&source=1';
$urlPreg = '#(http:\/\/)?([\w-]+\.)+[\w-]+(/[\w- ./?%&=]*)?#i';

function handleRow($row){
	$cells = $row->getElementsByTagName('td');
	foreach($cells as $cell){
		$str = $cell->getAttribute('class');
		switch($str){
		case 'data':
			$message = $cell->textContent;
			preg_match_all($GLOBALS['urlPreg'], $message, $results);
			echo 'url='.$results[0][0];
			break;
		case 'song':
			$strong = $cell->getElementsByTagName('strong')->item(0);
			if($strong){
				$songName = $strong->textContent;
				echo '|sname:'.$songName;
			}
			break;
		case 'singer':
			$superLink = $cell->getElementsByTagName('a')->item(0);
			if($superLink){
				$singerUrl = $superLink->getAttribute('href');
				$singerName = $superLink->textContent;
				echo '|singer='.$singerName;
			}
			break;
		case 'size':
			$size = $cell->nodeValue;
			echo '|size='.$size;
			break;
		}
	}
	echo ';';
}

function handleSongBox($table){
	$index = 0;
	$rows = $table->getElementsByTagName('tr');
	foreach($rows as $row){
		if($index != 0){
			handleRow($row);
		}
		$index ++;
	}
}

function getURL($url){
	error_reporting(E_ERROR|E_PARSE|E_CORE_ERROR); 
	$htmlDoc = new DOMDocument;
	$htmlDoc->loadHTMLFile($url);
	$htmlDoc->normalizeDocument();
	$tables = $htmlDoc->getElementsByTagName('table');
	$count = $tables->length;
	foreach($tables as $songBox){
		$tableProp = $songBox->getAttribute('class');
		if($tableProp == 'song_box'){
			handleSongBox($songBox);
			return;
		}
	}
}

getUrl($url);
?>