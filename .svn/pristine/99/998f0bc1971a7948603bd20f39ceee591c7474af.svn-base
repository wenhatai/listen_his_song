/*!myPlayerlist 增playlist也增，myPlayerlist删playlist也删*/
//其实，playlist也没用，所有的信息都在html保存的有
//playlist唯一的优点是能保存usid
//playlist也不能保证与myPlayerlist同步
var playlist =new Array();
var myPlayerlist;
var searchRet;
var isNewSong = false;
var newSongIndex = -1;
var newSongSrcUrl = "";

/*!是否在当前播放列表里面，不考虑专辑信息，如果存在返回index*/
function isInCurrentPlaylist(sname, singer){
	var $ul = $("#playlist ul").children("li");
	var i;
	for(i = 0; i < $ul.length; i ++){
		var content = $ul.eq(i).find("a").text();
		if(content.indexOf(sname) >=0 
			&& content.indexOf(singer) >= 0){
			return i;
		}
	}
	return false;
}

function addNewSongAndListenedRecordOnServer(){
	if(newSongIndex == -1 || newSongSrcUrl == ""){
		return -1;
	}
	var sname = searchRet.soso[newSongIndex].name;
	var singer = searchRet.soso[newSongIndex].singer;
	var album = "none";
	if(typeof searchRet.soso[newSongIndex].album != "undefined"){
		album = searchRet.soso[newSongIndex].album;
	}
	var srcUrl = newSongSrcUrl;
	newSongIndex = -1;
	newSongSrcUrl = "";
	$.ajax({
		url:"p/song/addsong.php",
		method:"POST",
		data:{
			"sname":sname,
			"singer":singer,
			"album":album,
			"src":srcUrl,
			"openid":openid,
		},
		success:function(data){
			playlist.push({
				"usid":data,
				"singer":singer,
				"sname":sname,
				"src":data[0].url,
			});
		}
	});
}

function listenANewSong(sid){
	$.ajax({
		url:"p/song/addToSongsList.php",
		method:"POST",
		data:{
			"sid":sid,
			"openid":openid,
		},
		success:function(data){
			alert(data);
		}
	});
}

function getMySongList(){
	$.ajax({
		url:"p/showsong_whenin.php",
		method:"post",
		data:{'openid':openid},
		dataType:"json",
		success:function(ret){
			if(ret.num == 0){
				$("#playlist").append("<li id='not' class='jp-playlist-item' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
					"对不起 ！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 您还没有播放列表！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
					"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>");			   
			} else {
				for(var i=0; i<ret.num; i++){
					myPlayerlist.add({
						title:ret.songs[i].name,
						artist:ret.songs[i].singer,
						free: true,
						mp3:ret.songs[i].src,
					});
					playlist.push({
						"usid":ret.songs[i].usid,
						"sname":ret.songs[i].name,
						"singer":ret.songs[i].singer,
						"src":ret.songs[i].src,
						"album":ret.songs[i].album,
					});
				}
				var temp = $("a.jp-playlist-current").html();
				$("div#jp-music-title h2").html(temp);
				$("#return").attr({"disabled":"disabled"});
				$("#last").attr({"disabled":"disabled"});
			}
		}
	});
}

function saveSongListenedRecordOnServer(songname){
	$.ajax({
		url:"p/addsongtimes.php",
		type:"post",
		data:{"songname":songname},		   
	});
}

function displaySearchResult(songs, tag){
	var albumFiller = "";
	for(var i=0; i<songs.num; i++){
		if(songs[i].album != undefined){
			albumFiller = "" + songs[i].album;
			if(albumFiller.length > 5){
				albumFiller = albumFiller.substr(0,4) + "...";
			}
		} else {
			albumFiller = "";
		}
		$("#list_all > ul").append("<li class='jp-playlist-item'  id='" +tag+"_"+i+"'>"
								+"<span class='list1'>"+songs[i].name+"</span>"
								+"<span class='list2'>"+songs[i].singer+"</span>"
								+"<span class='list3' alt='"+songs[i].album+"'>"+albumFiller+"</span>" +
							"</li>");  
	}
}

function enableSearchItemDoubleClicked(){
	$("#list_all ul li").click(function(){
		var info = this.id.split('_');
		var index = info[1];
		if(info[0] == "soso"){
			var urls = "";
			var i;
			for(i = 0; i < searchRet.soso[index].url.length; i++){
				urls += searchRet.soso[index].url[i] + '|';
			}
			alert(searchRet.soso[index].name);
			$.ajax({
				url:"p/soso/bysoso.php",
				method:"POST",
				data:{
					"sname":searchRet.soso[index].name,
					"singer":searchRet.soso[index].singer,
					"urls":urls,
					"num":i,
				},
				dataType:"json",
				success:function(data){
					alert(data[0].url);
					var ret = isInCurrentPlaylist(
						searchRet.soso[index].name, 
						searchRet.soso[index].singer
					);
					if(ret){
						myPlayerlist.play(ret);
						return;
					}
					myPlayerlist.add({
						artist:searchRet.soso[index].singer,
						title:searchRet.soso[index].name,
						free: true,
						mp3:data[0].url,
					});
					newSongIndex = index;
					newSongSrcUrl = data[0].url;
					myPlayerlist.play(-1);
					$("#list_all ul li.jp-playlist-current").removeClass("jp-playlist-current");
					isNewSong = true;
				},
			});
		} else if(info[0] == "db") {
			var ret = isInCurrentPlaylist(
				searchRet.db[index].name, 
				searchRet.db[index].singer
			);
			if(ret){
				myPlayerlist.play(ret);
				return;
			}
			myPlayerlist.add({
				artist:searchRet.db[index].singer,
				title:searchRet.db[index].name,
				free: true,
				mp3:searchRet.db[index].src,
			});
			myPlayerlist.play(-1);
			$("#list_all ul li.jp-playlist-current").removeClass("jp-playlist-current");
			listenANewSong(searchRet.db[index].sid);
		}
	});
}

$(document).ready(function(){
	myPlayerlist = new jPlayerPlaylist(
	{
		jPlayer: "#jquery_jplayer_1",
		cssSelectorAncestor: "#jp_container_1"
	}, 
	[], 
	{
		playlistOptions: {
			autoPlay: false,
			loopOnPrevious: true,
			shuffleOnLoop: true,
			enableRemoveControls: true,
		},
		swfPath: "js/Jplayer.swf",
		supplied: "mp3",
		verticalVolume: true,
		volume: 0.75,
		preload: "auto",
		wmode: "window"
	});
	
	getMySongList();
	
	oldSongSrc = "";
	/*! 为歌曲播放事件绑定功能*/
	$("#jquery_jplayer_1").bind($.jPlayer.event.play,function(event){
	    var newSongSrc = event.jPlayer.status.src;
		if(newSongSrc==oldSongSrc){
			return;
		}
		var temp = $("a.jp-playlist-current").html();
		$("div#jp-music-title h2").html(temp);
		var songname = $("div.jp-playlist ul li.jp-playlist-current a").next().next().html();
		saveSongListenedRecordOnServer(songname);
		oldSongSrc = newSongSrc;
	});
	
	/*!一首新歌被收录进来*/
	$("#jquery_jplayer_1").bind($.jPlayer.event.progress,function(event){
		if(isNewSong){
			alert("New");
			addNewSongAndListenedRecordOnServer();
		}
		isNewSong = false;
	});
	
	$("#return").live('click',function(){
		$('#list_all').hide();
		$('#playlist').show();
		//myPlayerlist.setPlaylist(playlist);
		$(this).attr({"disabled":"disabled"});
		$("#last").attr({"disabled":"disabled"});
	});
	
	$("#last").change(function(){
		document.getElementById('playlist').style.display ="block";
		document.getElementById('list_all').style.display ="none";
		var opanel = document.getElementById("playlist");
		myPlayerlist.remove(); 
		var days=$("#last").find("option:selected").val();
		$.ajax({		
			url:"p/showsong_byrate.php",
			type:"POST",
			data:{"days":days,"openid":openid},
			dataType:"json",
			success:function(ret){ 
				if(ret.num==0){
					$("#playlist").append("<li class='jp-playlist-item' id='not' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"对不起 ！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 您这几天未听歌！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>");			   
				}else{
					if($("#not") != undefined){
						$("#not").remove();
					}
					var songlist = new Array();
					for(var i=0; i< ret.num; i++){
						songlist.push({
							artist:ret.songs[i].singer,
							title:ret.songs[i].name,
							free: true,
							mp3:"music/"+ret.songs[i].sid+"song.mp3",
						});
					}
					//myPlayerlist.setPlaylist(songlist);
				}
			}
		});
	});
	
	$("#search-text").click(function(){
		var text = document.getElementById("search-text");
		if(text == "输入你想要的音乐"){
			opanel1.value="";
		}
	});
	
	$("#search-sub").click(function(){
		var searchContent = $("#search-text").val();
		if(searchContent == "" || searchContent == "输入你想要的音乐")
		{
			alert("请输入搜索内容！");
			return;
		}
		$("#playlist").hide();
		$("#list_all").show();
		$("div#list_all").find("li#not").remove();
		$.ajax({
			url:"p/soso/searchsong.php",
			type:"POST",
			data:{"searchContent":searchContent},
			dataType:"json",
			success:function(data){
				var songsInDB = data.db;
				var songs = data.soso;
				$("#list_all > ul").empty();
				if(songs.num == 0){
					$("#list_all > ul").append("<li id='not' class='jp-playlist-item' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"对不起 ！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 未搜索到相关歌曲！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>");
				} else {
					searchRet = data;
					$("#list_all > ul").append("<li id='listtitle' class='jp-playlist-item' >"
											+"<span class='list1'>歌名</span>"
											+"<span class='list2'>歌手</span>"
											+"<span class='list3'>专辑</span>"+
										"</li>");		
					displaySearchResult(data.db, "db");
					displaySearchResult(data.soso, "soso");
					enableSearchItemDoubleClicked();
					$("#return").removeAttr("disabled");
				}
			}
		});
	});
	
	$("#delete").click(function(){
		var o=document.getElementById("list_all");
		var num=o.children.length;
		var idarray="";
		var k=0;
		for(var i=0;i<num;i++){
			if(o.children[i].className=="onthis"){
				k++;
				idarray=idarray+"|"+o.children[i].id
			}
		}
		if(k==0){
			alert("请在列表中选择您要删除的歌曲！");
		} else {
			var keyword = document.getElementById("list_all");
			var name=keyword.firstChild.id;
			$.ajax({
				url:"p/deletesong.php",
				method:"post",
				data:{"idarray":idarray,"name":name,"k":k},
				success:function(data){
				}
			});
			var string=idarray.split("|");
			var array= new Array();
			for(i=0;i<k;i++) {
				array[i]=string[i+1];  //把点击了的歌曲的id收集起来，并每个放在数组array中
			}

			var  m=document.getElementById("list_all");
			var  l=m.children.length;
			for(var i=0;i<l;i++) {
				if(m.children[i].className=="onthis") {
					m.removeChild(m.children[i]);
					l--;
				}			   
			}	
		}
	});
});
