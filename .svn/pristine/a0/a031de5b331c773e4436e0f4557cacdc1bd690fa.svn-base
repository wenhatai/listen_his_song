<?php
require_once("class.base.php");

class Song extends Conn{
	private $songName;
	private $singerName;
	
	// 构造函数
	function __construct($name=NULL, $singer=NULL){
		$this->songName = $name;
		$this->singerName = $singer;
	}
	
	function insert(){
		$sql = "INSERT INTO song (name, singer) VALUES (?, ?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $this->songName, $this->singerName);
		$stmt->execute();
		$stmt->close(); 
		$this->uid = $this->mysqli->insert_id;
		return $this->uid;
	}
	
	function isExist(){
		$ret = true;
		$sql = "SELECT * FROM song WHERE name = ? AND singer = ?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $this->songName, $this->singerName);
		$stmt->execute();
		$stmt->store_result();
		if($stmt->num_rows != 1){
			$ret = false;
		}
		$stmt->close(); 
		return $ret;
	}
	
	//查询我的播放列表中是否存在要插入的这首歌
	function is_myplaylist($id,$openid){
		$i=1;
		$sql = "SELECT sid FROM user_song WHERE openid = ?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("s",$openid);
		$stmt->execute();
		$stmt->bind_result($col);
		while($stmt->fetch()){
			if($col==$id){
				$stmt->close();
				return $i;
			}
			else
				$i++;
		}
		$stmt->close();
		return false;
	}
	
     //通过sid把某首听了的歌听歌次数加1
    function addsongtimes($sid)
     {
		$sql = "UPDATE user_song SET times_5d=times_5d+1 WHERE sid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i",$sid);
		$stmt->execute();
		$stmt->close();
		return true;
     }	 
	 
	//通过点击好友id获取好友的歌
	function friendsongs($id){
		$result=array();
		$song=new Song();
		$i=0;
		$sql="SELECT sid,times_5d,times_10d,times_15d,times_30d FROM user_song WHERE openid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("s",$id);
		$stmt->execute();
		$stmt->bind_result($col1,$col2,$col3,$col4,$col5);
		while($stmt->fetch()){
			$result[$i]['sid']=$col1;
			$result[$i]['5d']=$col2;
			$result[$i]['10d']=$col3;
			$result[$i]['15d']=$col4;
			$result[$i]['30d']=$col5;
			$result[$i]['song']=$song->song_info($col1);
			$i++;
		}
		$result['num'] = $i;
		$stmt->close();
		return $result;
	}
	
	
	
	//得到歌曲信息
	function song_info($sid){
		$result=array();
		$sql="SELECT name,singer,genre_name FROM song WHERE sid=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i",$sid);
		$stmt->execute();
		$stmt->bind_result($col1,$col2,$col3);
		if($stmt->fetch()){
			$result['name']=$col1;
			$result['singer']=$col2;
			$result['genre']=$col3;
		}
		$stmt->close();
		return $result;
	}
	
	//将好友列表中的歌曲的信息加入到自己的播放列表中
	function add_myplaylist($openid,$sid){
		$initial=1;
		$sql = "INSERT INTO user_song (openid,sid,times_5d,times_10d,times_15d,times_30d) VALUES (?,?,?,?,?,?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("siiiii",$openid,$sid,$initial,$initial,$initial,$initial);
		$stmt->execute();
		$stmt->close();
		return true;
	}
	
	function __get($property){
		if(isset($this->$property)){
			return $this->$property;
		} else {
			return NULL;
		}
	}
		
	function __set($property, $value){
		$this->$property = $value;
	}
}
?>