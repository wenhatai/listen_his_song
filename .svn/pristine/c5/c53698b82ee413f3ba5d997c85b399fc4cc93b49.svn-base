/*!创建分组*/
function createGroupOnServer(groupname){
	$.ajax({
		url:"p/group/addgroup.php",
		method:"POST",
		data:{'openid':openid, 'groupname':groupname},
		success:function(groupid){
			appendGroupByIdAndName(groupid, groupname);
			enableDragAndDrop();
		},
		error:function(){
			alert("服务器忙，请稍候重试！");
		}
	});
}

/*!重命名分组*/
function renameGroupOnServer(groupid,newGroupName){
	$.ajax({
		url:"p/group/renamegroup.php",
		method:"POST",
		data:{
			"openid":openid,
			"newgroup":newGroupName,
			"groupid":groupid
		},
		success:function(data){
			$("#groupid_"+groupid+ " span:first").html(newGroupName);
		}
	});
}

/*!从一个分组中删除一个好友*/
function removeFriendOnServer(friendElemId){
	var removeid = friendElemId.split("_");
	$.ajax({
		url:"p/group/removefriend.php",
		method:"GET",
		data:{
			"gid":removeid[0],
			"fid":removeid[1]
		},
		success:function(data){
			$("#"+friendElemId).remove();
		}
	});
}

$(document).ready(function(){
	$('.friendtitle').live('click', function(){
		if($(this).next('.list').css("display") == "block"){
			$(this).removeClass('choose').next('.list').hide(300);
		}else{
			$(this).addClass('choose').next('.list').show(300);
		}		
	});
	
	$("#addgroup input").hide();	
	$("#addgroup").click(function(){
		$(this).find("span").hide();
		$(this).find("input").show();
		$(this).find("input").focus()
	});
	
	$("#groupname").blur(function(){
		$(this).hide()
			   .parent().find("span").show();
	});
	
	$("#groupname").change(function(){
		$(this).hide()
			   .parent().find("span").show();
		var groupname = $(this).val();
		$(this).val("");
		if(groupname == ""){
			return;
		}
		createGroupOnServer(groupname);
	});
	
	$('li.grouping').contextMenu('myMenu1', {
		bindings: {
        'group_rename': function(t) {
			var groupid=t.id.substring(8);
			var oldgroup=$("#"+t.id+ " span:first").html();
			var newGroupName=prompt("重命名改组名称",oldgroup);
			if(newGroupName==""||newGroupName==oldgroup)
				return ;
			renameGroupOnServer(groupid, newGroupName);	
        },
        'group_delete': function(t) {
			var groupid=t.id.split('_')[1];
			if(!confirm("确定删除这一组吗？"))
				return ;
			$.ajax({
				url:"p/group/deletegroup.php",
				method:"POST",
				data:{"openid":openid,"groupid":groupid},
				success:function(data){
					$("#"+t.id).remove();
				}
			});
        }
      }
    });
	
	$('#repeat').click(function(){
		$('.jp-toggles-list').slideDown();
	});
	
	$('.jp-toggles-list a').click(function(){
		$('.jp-toggles-list').slideUp();
		$('#repeat img').attr('src','image/'+$(this).attr('class')+'.png');
	});
	
	$('#search input')
		.focus(function(){
			$(this).attr('value', '');
		})
		.blur(function(){
			if($(this).attr('value') == ''){
				$(this).attr('value', '输入你想要的音乐');
			}
		});
	
	$('.removefriend').live('click',function(){
		if(!confirm("确定删除?"))
			return ;
		var selectid = $(this).parent().attr('id');
		removeFriendOnServer(selectid);
	});
	
	/*!表情浮动窗口*/
	var isFaceBoxOpened = false;
	$( "#defaultface" ).dialog({
		autoOpen: false,
		show: { effect: 'slide', direction: "right" },
		height: 252,
		width: 383,
		hide: { effect: 'slide', direction: "down" },
		zIndex : 999,
		resizable: false,
		position: { 
			my: 'top top', 
			at: 'center center', 
			of: $(this), 
		},
	});
	
	/*!发表微博浮动窗口*/
	$( "#dialog" ).dialog({
		autoOpen: false,
		show: { effect: 'slide', direction: "right" },
		height: 232,
		width: 470,
		title: "发表微博",
		hide: { effect: 'slide', direction: "down" },
		zIndex : 2,
		buttons:{
			"表情":function(){
				if(isFaceBoxOpened){
					$( "#defaultface" ).dialog("close");
					$( "#defaultface" ).prev(".ui-dialog-titlebar").show(1000);
				} else {
					$( "#defaultface" ).dialog("open");
					$( "#defaultface" ).prev(".ui-dialog-titlebar").hide();
				}
				isFaceBoxOpened = !isFaceBoxOpened;
			},
			"广播":function(){
				var content = $("#content").val();
				punblishtapp($.trim(content));
			}
		},
		close:function(){
			if(isFaceBoxOpened){
				$( "#defaultface" ).dialog("close");
				$( "#defaultface" ).prev(".ui-dialog-titlebar").show(1000);
			}
			isFaceBoxOpened = false;
		}
	});
	
	/*!发布微博按钮，点击会让发表微博窗口显现*/
	$( "#publish-weibo" )
		.button()
		.click(function() {
			var x = $(this).position().left - 320;
			var y = $(this).position().top - 210;
			$("#dialog").dialog('option', 'position', [x,y]);
			$( "#dialog" ).dialog( "open" );
			return false;
		});
	
	/*!一个表情被点击时，同步内容到微博发布窗口*/
	$("#facebox > img").click(function(){
		var text = $("#content").val();
		var title = this.title;
		$("#content").val($.trim(text) + '/' + title);	
		$( "#defaultface" ).dialog("close");
		$( "#defaultface" ).prev(".ui-dialog-titlebar").show(1000);
		isFaceBoxOpened = false;
	});
		
});