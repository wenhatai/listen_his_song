<?php
require_once("class.base.php");
require_once("class.friend.php");

class Group extends Conn{
	
	function insert($openid, $groupName){
	    $sql = "INSERT INTO fgroup (openid,name) VALUES (?, ?)";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ss", $openid, $groupName);
		$stmt->execute();
		$stmt->close();
		$this->uid = $this->mysqli->insert_id;
		return $this->uid;
	}
	
	function getMyGroups($myopenid){
		$result = array();
		$friend = new Friend();
		$sql = "SELECT id,name FROM fgroup WHERE openid = ?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("s", $myopenid);
		$stmt->execute();
		$stmt->bind_result($gid, $gname);
		$i = 0;
		while($stmt->fetch()){
			$result[$i] = array();
			$result[$i]['id'] = $gid;
			$result[$i]['name'] = $gname;
			$result[$i]['friends'] = $friend->findFriendsInGroup($gid);
			$i++;
		}
		$stmt->close();
		return $result;
	}
	
	function renameGroup($myopenid,$name,$id){
		$sql="UPDATE fgroup SET name=? WHERE openid=? AND id=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("ssi", $name,$myopenid,$id);
		$stmt->execute();
		$stmt->close();
		return true;
	}
	
	function deleteGroup($myopenid,$id){
		$sql2 = "DELETE FROM friend  WHERE gid=?";
		$stmt2 = $this->mysqli->prepare($sql2);
		$stmt2->bind_param("i",$id);
		$stmt2->execute();
		$stmt2->close();
		
		$sql = "DELETE FROM fgroup WHERE id=?";
		$stmt = $this->mysqli->prepare($sql);
		$stmt->bind_param("i", $id);
		$stmt->execute();
		$stmt->close();
		return true;
	}
}
?>