var playlist =new Array();
var myPlayerlist;

function getMySongList(){
	$.ajax({
		url:"p/showsong_whenin.php",
		method:"post",
		data:{'openid':openid},
		dataType:"json",
		success:function(ret){
			if(ret.num == 0){
				$("#playlist").append("<li id='not' class='jp-playlist-item' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
					"对不起 ！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 您最近未听歌！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
					"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>");			   
			} else {
				for(var i=0; i<ret.num; i++){
					myPlayerlist.add({
						title:ret.songs[i].name,
						artist:ret.songs[i].singer,
						free: true,
						mp3:"music/"+ret.songs[i].sid+"song.mp3",
					});
					playlist.push({
						title:ret.songs[i].name,
						artist:ret.songs[i].singer,
						free: true,
						mp3:"music/"+ret.songs[i].sid+"song.mp3",
					});
				}
				var temp = $("a.jp-playlist-current").html();
				$("div#jp-music-title h2").html(temp);
				$("#return").attr({"disabled":"disabled"});
				$("#last").attr({"disabled":"disabled"});
			}
		}
	});
}

$(document).ready(function(){
	myPlayerlist = new jPlayerPlaylist(
	{
		jPlayer: "#jquery_jplayer_1",
		cssSelectorAncestor: "#jp_container_1"
	}, 
	playlist, 
	{
		playlistOptions: {
			autoPlay: false,
			loopOnPrevious: true,
			shuffleOnLoop: true,
			enableRemoveControls: true,
		},
		swfPath: "js/Jplayer.swf",
		supplied: "mp3",
		verticalVolume: true,
		volume: 0.75,
		wmode: "window"
	});
	
	getMySongList();
	//$("a.jp-playlist-item").live('click',function(){
	//	var songname = $(this).text();
	//	$("div#jp-music-title h2").text(songname) ;  
	//});
	
	oldSongSrc = "";
	//alert(event.jPlayer.status.src);
	$("#jquery_jplayer_1").bind($.jPlayer.event.play,function(event){
	    var newSongSrc = event.jPlayer.status.src;
		if(newSongSrc==oldSongSrc){
			return;
		}
		var temp = $("a.jp-playlist-current").html();
		$("div#jp-music-title h2").html(temp);
		var songname = $("div.jp-playlist ul li.jp-playlist-current a").next().next().html();
		$.ajax({
			url:"p/addsongtimes.php",
			type:"post",
			data:{"songname":songname},		   
		});	  
		oldSongSrc = event.jPlayer.status.src;
	});

	$("#list_all").live("click",function(){
		var id=window.event.srcElement.id.substring(4);
		if(isNaN(id)){
			return ;
		}
		if(id=="")
			return ;
		$.ajax({
			url:"p/clickingsong.php",
			type:"POST",
			data:{"id":id,"openid":openid},
			success:function(data){
				if(!isNaN(data)){
					num=data-1;
					myPlayerlist.play(num);
					return ;
				}
				var song = eval('(' + data + ')');
				var path="music/"+id+"song.mp3";
				playlist.push({
					artist:song.singer,
					title:song.name,
					free: true,
					mp3:path,
				});
				myPlayerlist.add({
					artist:song.singer,
					title:song.name,
					free: true,
					mp3:path,
				});
				myPlayerlist.play(-1);
			    document.getElementById('playlist').style.display ="none";
			}
		});
	});
	
	$("#return").live('click',function(){
		document.getElementById('playlist').style.display ="block";
		document.getElementById('list_all').style.display ="none";
		myPlayerlist.setPlaylist(playlist);
		$(this).attr({"disabled":"disabled"});
		$("#last").attr({"disabled":"disabled"});
	});
	
	$("#last").change(function(){
		document.getElementById('playlist').style.display ="block";
		document.getElementById('list_all').style.display ="none";
		var opanel = document.getElementById("playlist");
		myPlayerlist.remove(); 
		var days=$("#last").find("option:selected").val();
		$.ajax({		
			url:"p/showsong_byrate.php",
			type:"POST",
			data:{"days":days,"openid":openid},
			dataType:"json",
			success:function(ret){ 
				if(ret.num==0){
					$("#playlist").append("<li class='jp-playlist-item' id='not' >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"对不起 ！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 您这几天未听歌！&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
						"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>");			   
				}else{
					if($("#not") != undefined){
						$("#not").remove();
					}
					var songlist = new Array();
					for(var i=0; i< ret.num; i++){
						songlist.push({
							artist:ret.songs[i].singer,
							title:ret.songs[i].name,
							free: true,
							mp3:"music/"+ret.songs[i].sid+"song.mp3",
						});
					}
					myPlayerlist.setPlaylist(songlist);
				}
			}
		});
	});
});
